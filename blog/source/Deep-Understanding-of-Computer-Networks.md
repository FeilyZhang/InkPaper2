title: "深入理解计算机网络（一）"
date: 2019-07-05 15:27:14 +0800
update: 2019-07-05 15:27:14 +0800
author: me
cover: "-/images/computernetworks.jpg"
tags:
    - Networks
preview: OSI/RM七层体系结构、TCP/IP协议四层体系结构、MAC子层功能、帧格式、ARP协议、网络层功能、IP数据报格式、IP地址、子网掩码与子网划分。

---

## 一、OSI/RM七层体系结构

![OSI/RM七层体系结构](/images/article/osi.jpg)

## 二、TCP/IP协议四层体系结构

![TCP/IP协议四层体系结构](/images/article/tcpip.jpg)

## 三、MAC子层功能、帧格式、ARP协议

#### 3.1 MAC子层功能

+ MAC帧的封装与拆卸；
+ 实现和维护各种MAC协议；
+ 比特流差错检测；
+ MAC寻址。

MAC帧分为以下三种：

+ 单播帧：目的MAC地址是一个单播MAC地址的帧；
+ 广播帧：目的MAC地址是一个广播MAC地址的帧；
+ 多播帧：目的MAC地址是一个多播MAC地址的帧。

#### 3.2 MAC帧格式

![MAC帧格式](/images/article/macframe.jpg)

#### 3.3 ARP协议

ARP协议（Address Resolution Protocol, 地址解析协议）是将IP地址解析为以太网MAC地址（或物理地址）的协议。在局域网中，当主机或其他网络设备有数据要发送给另一个主机或设备时，它必须知道对方的网络层地址（即IP地址）。但是仅仅有IP地址是不够的，因为IP数据报文必须封装为帧才能通过物理网络发送，因此发送站还必须有接收站的物理地址，所以需要一个从IP地址到物理地址的映射。ARP就是实现这个功能的协议。

ARP的报文格式如下

![ARP的报文格式](/images/article/arp.jpg)

ARP地址解析原理：

+ 同一网段中两主机的ARP地址解析的全过程：
    1. 主机A首先查看自己的ARP表（该表是一个IP地址与MAC地址的映射表），确定其中是否包含主机B的IP地址和对应的MAC地址。如果找到了对应IP的MAC地址，则主机A直接利用ARP表中的MAC地址对IP数据包进行封装，并将数据包发送给主机B；
    2. 如果主机A在ARP表中找不到对应的MAC地址，则先缓存该数据报文，然后以广播方式（目的MAC地址为广播MAC地址——FFFFFF，同网段的任意节点均可收到）发送一个ARP请求报文；
    3. 主机B发现ARP请求报文中的IP地址与自己的一致，就将ARP请求报文中的发送端的IP地址和MAC地址存入自己的ARP表中，然后以单播方式向主机A发送一个ARP响应报文，应答报文就包含了自己的MAC地址；
    4. 主机A接收到了主机B的应答报文，将主机B的MAC地址存入自己的ARP表中以用于后续报文的转发，同时将原来缓存的IP数据包再次修改（即填上对方的MAC地址）然后发送出去。
+ 不同网段中两主机的ARP地址解析的全过程：
    1. 如果主机A不知道网关（主机A所在网的网关）的MAC地址（即主机A的ARP表中没有网关对应的MAC地址表项），则主机A先在本网段中发出一个ARP请求广播，ARP请求报文中的目的IP地址为网关IP地址，代表想获得网关的MAC地址，**如果主机A已经知道网关的MAC地址，则略过此步**；
    2. 网关收到ARP广播包后同样会向主机A发回一个ARP应答包。当主机A从收到的应答报文中获得网关的MAC地址后，在主机A向主机B发送原报文的目的MAC地址字段上填上网关的MAC地址后发给网关；
    3. 如果网关的ARP表中已有主机B对应的MAC地址，则网关直接将来自主机A的报文中的目的MAC地址字段填上主机B的MAC地址后转发给主机B；
    4. 如果网关ARP映射表中没有主机B的MAC地址，网关会再次向主机B所在网段发送ARP广播请求，此时目的IP地址为主机B的IP地址，当网关从收到来自主机B的应答报文中获得主机B的MAC地址后，就可以将由主机A发来的报文重新在目的MAC地址字段填上主机B的MAC地址后发送给主机B。
	
可见，数据包的转发是一场接力赛。

## 四、网络层功能、IP数据报格式、IP地址、子网掩码与子网划分

#### 4.1 网络层的功能

+ 屏蔽网络差异，提供透明传输；
+ 为网络间通信提供路由选择；
+ 数据包封装和解封装；
+ 拥塞控制

#### 4.2 IP数据报格式

![IP数据报格式](/images/article/ip.jpg)

#### 4.3 IP地址、子网掩码与子网划分

IPv4使用32位（4字节）地址，因此整个地址空间中有2<sup>32</sup>个地址，也就是近43亿个地址，不过其中一些地址是为特殊用途保留的，实际上可在广域网上使用的、路由的公网IP就不多了。IPv4地址被分为5类，如下

+ A类IPv4地址：网络ID最高位固定为`0`，后面的7位可变。也就意味着A类网络数目为128个（2<sup>7</sup>）,但实际上可用的只有126个，因为网络ID为0（保留地址）和127（本地环路测试地址）的A类网络不可用；那么32位IP地址还剩下24位，所以每个A类网络中可用的主机ID数为2<sup>24</sup>个，但是主机ID全为0和全为1的地址为广播地址，不能分配使用，所以可用地址数为2<sup>24</sup>-2个。可见，A类网络可以构建的网络数目最少，但每个网络中拥有的主机数最多，适用于大型企业和运营商。
+ B类IPv4地址：网络ID占用最高的前两个字节，最高字节的前两位固定为`10`，后面的14位可变，即B类网络数目为2<sup>14</sup>个；B类IP地址中主机ID为16位，所以每个网络拥有的IPv4地址数为2<sup>16</sup>个，同样主机ID全为1和0的不能分配使用，因此最终的可用地址数为2<sup>16</sup>-2个；
+ C类IPv4地址：网络ID占用最高的前三个字节，最高三位固定为`110`，后面的21位可变，即C类网络数目为2<sup>21</sup>个，C类IP地址中主机ID仅剩一个字节，所以可用的主机ID数仅有2<sup>8</sup>个，同样全为0的地址为网络地址，全为1的地址为广播地址不能使用，所以仅有2<sup>8</sup>-2个可以使用；
+ D类IPv4地址：为组播地址，用于IPv4的组播通信中，前四位固定为`1110`，剩余28位可变；
+ E类IPv4地址：属于IANA保留地址，不分配给用户使用，前5位分别为`11110`，剩余27位可变。

子网掩码是为了满足IPv4地址分配的层次特点而提出的，也是提高IP地址资源利用率的一种手段，<span style="color:red">**可以通过与ID地址做逻辑与运算得到IP地址的网络部分（由于每个网络会被划分为若干个子网，这样仅通过IP地址无法确定网络号是多少，但是通过IP地址与子网掩码做逻辑与运算就可以得到网络号，从而进行数据报传输。需要注意的是，子网划分中向主机号借位仅仅是为了同一网络下子网的划分并不会改变网络号，缺点就是网络号不容易辨认，）**</span>。与IPv4地址相同，子网掩码也由1和0组成，且长度也是32位，也可以分为网络ID与主机ID两部分，各自的长度与IP地址网络ID与主机ID的长度相对应。只不过子网掩码中网络IP部分全是1，主机IP部分全为0.

+ A类IP地址的子网掩码：固定为`255.0.0.0`，因为子网掩码网络ID部分全部为1，主机ID部分为0，而A类地址中网络ID部分就是最高的那个字节；
+ B类IP地址的子网掩码：固定为`255.255.0.0`，因为子网掩码网络ID部分全部为1，主机ID部分为0，而B类地址中网络ID部分就是最高的前两个字节；
+ C类IP地址的子网掩码：固定为`255.255.255.0`，因为子网掩码网络ID部分全部为1，主机ID部分为0，而B类地址中网络ID部分就是最高的前三个字节；

同时子网掩码也是一种解决IPv4地址不足的手段。子网掩码划分的本质是通过向主机ID部分借位实现网络子网划分，借一位在当前网络中产生两个子网，相应地主机ID缩减一个bit位，借两位产生4个子网，以此类推。子网号的位数越多，那么当前网络下划分的子网越多，同样每个子网的主机数越少。