title: "深入理解计算机网络（二）"
date: 2019-07-05 19:00:14 +0800
update: 2019-07-05 19:00:14 +0800
author: me
cover: "-/images/computernetworks.jpg"
tags:
    - Networks
preview: 传输层功能、TCP与UDP、应用层HTPP协议、DNS协议。

---

## 一、传输层功能、TCP与UDP

#### 1.1 传输层功能

+ 传输层寻址；
+ 传输连接建立；
+ 数据传输；
+ 传输连接释放；
+ 流量控制；
+ 拥塞控制；
+ 多路复用和解复用；
+ 崩溃恢复。

#### 1.2 TCP协议

##### 1.2.1 TCP协议的主要特性

1. 面向连接的传输协议：即应用程序在使用TCP之前，必须先建立TCP连接，在传输数据完毕后，必须释放已建立的TCP传输连接；
2. 仅支持单播传输：即只能进行点对点的数据传输，不支持多播和广播传输方式；
3. 提供可靠的交付服务：即TCP连接传送的数据可以无差错、不丢失、不重复，且按时序到达对端；
4. 传输单位为数据段：仍采用了传统的“数据段”作为传输单元；
5. 仅一种TPDU格式；
6. 支持全双工传输：允许通信双方的应用程序在任何时候都能发送数据，因为TCP的两端都设有发送和缓存，用来临时存放双向通信的数据；
7. TCP连接是基于字节流的，而非报文流；
8. 每次发送的TCP数据段大小和数据段数都是可变的。

##### 1.2.2 TCP数据段格式

![TCP数据段格式](/images/article/tcp.jpg)

+ 序号：在一个TCP连接中，传输的数据字节流中的每一个数据字节都要按顺序进行编号；比如一个数据段的“序号”字段值是101.而该数据段中共有100字节，那么表明本数据段的最后一个字节的编号是200。那么下一次发送时，数据的序号字段值应该是201而不是102；
+ 确认号：指期望接收到对方下一个数据段中“数据”部分的第一个字节序号。这里的确认号就是上文的201；
+ 数据偏移：指数据段中“数据部分”距离TCP数据段起始处的字节偏移量；
+ URG：紧急指针控制位，置为1表明有紧急数据；
+ ACK：确认控制位，指示TCP数据段中的“确认号”字段是否有效，仅当该位为1时，才表示“确认号”字段有效，否则表示无效；
+ PSH：推控制位，指示是否需要立即把收到的该数据段提交给应用进程；
+ RST：重置控制位，用于重置、释放一个已经混乱的传输连接，然后重新建立新的传输连接；
+ SYN：同步控制位，用来在传输连接建立时同步传输连接信号，置为1时表示这是一个连接请求或连接确认报文。当SYN=1,而ACK=0时，表示这是一个连接请求数据段，如果对方同意建立连接，则会返回一个SYN=1,ACK=1的确认；
+ FIN：最后控制位，用于释放一个传输连接，当置为1时，表示数据已全部传输完成，发送端没有数据传输了，要求释放当前连接，但是接收端仍然可以继续接收还没有接收完的数据，在正常传输中，应该置为0；
+ 窗口大小：指示发送此TCP数据段的主机上用来存储传入数据段的窗口大小，即发送者当前还可以接收的最大字节数；
+ 检验和：对数据段头、数据以及伪头部这三部分进行检验；
+ 紧急指针：仅当前面的URH控制位置为1时才有意义，它指出本数据段中最为紧急数据的字节数。

##### 1.2.3 TCP三次握手与四次挥手

![TCP三次握手](/images/article/tcpthree.jpg)

![TCP四次挥手](/images/article/tcpfour.jpg)

#### 1.3 UDP协议

##### 1.3.1 UDP协议的特点

+ 无连接性：在发送数据前不需要建立连接，当然在数据发送结束后无须释放连接；
+ 不可靠性：适用于一些短消息类的数据传输；
+ 以报文为边界：直接对应用层提交的报文进行封装、传输，但是不拆分，也不合并；
+ 无流量控制与拥塞控制功能：因为这类数据的连续性比数据的完整性更重要，允许数据在传输过程中有部分丢失；
+ 支持各种交互通信方式：可以是一对一、一对多、多对多的方式。

###### 1.3.2 UDP数据报头部格式

![UDP数据报头部格式](/images/article/udp.jpg)

#### 1.4 TCP与UDP的区别

1. TCP面向连接,而UDP是无连接的;
2. TCP提供可靠的服务，无差错，不丢失，不重复，且按序到达;UDP尽最大努力交付，即不保证可靠交付；
3. TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流;UDP是面向报文的；UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）
4. 每一条TCP连接只能是点到点的;UDP支持一对一，一对多，多对一和多对多的交互通信；
5. TCP首部开销20字节;UDP的首部开销小，只有8个字节；
6. TCP的逻辑通信信道是全双工的可靠信道，UDP则是不可靠信道。

## 二、应用层HTPP协议、DNS协议

#### 2.1 HTTP协议的主要特点

+ 客户端 / 服务器（C / S）模式；
+ 无连接：指的是进行Web应用前无须建立专门的HTTP应用层会话连接，直接利用传输层建立好的TCP传输连接即可；
+ 高可靠性：虽然HTTP协议本身是不可靠的无连接协议，但它使用了可靠的TCP传输层协议；
+ 无状态：指的是Web服务器不会记住这个客户端曾经访问过这个页面；
+ 简单快速：客户端访问服务器，只需要传送请求方法和路径即可；

#### 2.2 HTTP请求与响应报文格式

请求报文格式如下

```
GET /bundle/index.js HTTP/1.1
Host: localhost:8000
Connection: keep-alive
User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1
Accept: */*
Referer: http://localhost:8000/
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
If-Modified-Since: Fri, 05 Jul 2019 12:23:24 GMT
```

响应报文格式如下

```
HTTP/1.1 304 Not Modified
Last-Modified: Fri, 05 Jul 2019 12:23:24 GMT
Date: Fri, 05 Jul 2019 12:26:56 GMT
```

#### 2.3 DNS协议递归解析的基本流程

1. 客户端向本机配置的本地名称服务器发出DNS域名查询请求；
2. 本地名称服务器收到请求后，先查询本地的缓存，如果有该域名的记录项，则本地名称服务器直接把查询的结果返回给客户端；如果本地缓存中没有该域名的记录，则本地名称服务器再以DNS客户端的角色发送与前面一样的DNS域名查询请求给根名称服务器；
3. 根名称服务器收到DNS请求后，把查询到的所请求的DNS域名中顶级域名所对应的的顶级名称服务器地址返回给本地名称服务器；
4. 本地名称服务器根据根名称服务器返回的顶级名称服务器地址，向对应的顶级名称服务器发送与前面一样的DNS域名查询请求；
5. 对应的顶级名称服务器在收到DNS查询请求后，也是先查询自己的缓存，如果有所请求的DNS域名的记录项，则先把对应的记录项返回给本地名称服务器地址，然后再由本地名称服务器返回给DNS客户端，否则向本地名称服务器返回所请求的DNS域名中的二级域名所对应的的二级名称服务器地址；

然后，本地名称服务器继续按照前面介绍的方法一次次地向三级、四级名称服务器查询，直到最终的对应域名所在区域的权威名称服务器返回最终的记录给本地名称服务器，再由本地名称服务器返回给DNS客户，同时本地名称服务器会缓存本次查询得到的记录项。